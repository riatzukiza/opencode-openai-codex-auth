In lib/request/request-transformer.ts around lines 952 to 968, the
TransformResult interface is currently unexported which prevents consumers from
using the return type of transformRequestBody; change the declaration to export
interface TransformResult so it’s exported from the module, and update any local
references or imports elsewhere if needed to use the exported type (no other
logic changes).


In lib/request/request-transformer.ts around lines 621 to 633, the code
duplicates the bridge message object creation (the developer role message with
CODEX_OPENCODE_BRIDGE and input merging) which is repeated later at lines
~658-667; extract a small helper (e.g., buildBridgeMessage(input):
Array<Message> or getBridgeMessage(input): Message[]) that returns the array
with the bridge message followed by the existing input and replace both
duplicated branches with a call to that helper, keeping existing types and
imports and ensuring generateContentHash("add") checks still control whether to
return the helper result or the original input.


In lib/compaction/compaction-executor.ts around lines 24 to 66, wrap the
response.text() + JSON.parse(...) and subsequent payload manipulation in a
try/catch so non‑JSON or unexpected response shapes do not crash compaction; on
any parse or processing error, log or ignore the error and return the original
response object untouched. Ensure the catch block returns the original Response
(preserving status, statusText, headers, and body) so callers receive the
unmodified response when parsing fails.


In lib/compaction/codex-compaction.ts around lines 168 to 170, the cloneRange
function duplicates logic already implemented in lib/utils/clone.ts as
cloneInputItems; replace the local implementation by importing cloneInputItems
from 'lib/utils/clone' and call it where cloneRange is used (or rename uses to
cloneInputItems), remove the duplicate function, and ensure the import is added
and TypeScript types align with InputItem[].


In lib/compaction/codex-compaction.ts around lines 131 to 144, the
extractTextFromItem function duplicates logic already in
lib/utils/input-item-utils.ts; replace this local implementation by importing
and calling the centralized utility (ensuring the import path is correct), and
if needed adapt or wrap the utility call so behavior remains identical (handle
null/undefined input and array/object type checks the same way as the previous
local function). Remove the duplicated function, run type checks/TS compile and
unit tests to confirm no behavioral regressions.


lib/cache/cache-metrics.ts lines 34-53 (also apply similar changes at 59-79,
103-105, 167-185): the metrics object and API are tightened to prevent
accidental writes to the aggregate bucket but getMetrics currently performs only
a shallow clone so callers can still mutate nested CacheMetrics; update the
types to use keyof Omit<CacheMetricsCollection, "overall"> for per-key
operations (hits/misses/evictions) and ensure every place that updates rates
also recomputes and updates the "overall" hitRate consistently, and either
return a deep-cloned/read-only snapshot from getMetrics or clearly document the
return as read-only to prevent external mutation.

In lib/cache/cache-warming.ts around lines 113 to 126, the catch block declares
an unused named parameter (_error) causing lint/typecheck warnings; remove the
unused binding by changing the catch to a bare catch (i.e., catch { ... }) so
the error is still ignored and the function behavior remains identical while
satisfying the linter.

In lib/compaction/codex-compaction.ts around lines 131 to 144, the
extractTextFromItem function duplicates logic already in
lib/utils/input-item-utils.ts; replace this local implementation by importing
and calling the centralized utility (ensuring the import path is correct), and
if needed adapt or wrap the utility call so behavior remains identical (handle
null/undefined input and array/object type checks the same way as the previous
local function). Remove the duplicated function, run type checks/TS compile and
unit tests to confirm no behavioral regressions.

In lib/compaction/codex-compaction.ts around lines 168 to 170, the cloneRange
function duplicates logic already implemented in lib/utils/clone.ts as
cloneInputItems; replace the local implementation by importing cloneInputItems
from 'lib/utils/clone' and call it where cloneRange is used (or rename uses to
cloneInputItems), remove the duplicate function, and ensure the import is added
and TypeScript types align with InputItem[].

In lib/compaction/compaction-executor.ts around lines 24 to 66, wrap the
response.text() + JSON.parse(...) and subsequent payload manipulation in a
try/catch so non‑JSON or unexpected response shapes do not crash compaction; on
any parse or processing error, log or ignore the error and return the original
response object untouched. Ensure the catch block returns the original Response
(preserving status, statusText, headers, and body) so callers receive the
unmodified response when parsing fails.

