* **`codexMode` is `true` by default** → you’re in **Codex bridge** mode (adds the Codex↔OpenCode *bridge* system message).
* To use the **tool-call remap** prompt instead, set **`CODEX_MODE=0`** (or put `"codexMode": false` in `~/.opencode/openai-codex-auth-config.json`).

---

## about the code you pasted (the conflict markers)

You pasted a `request-transformer.ts` with unresolved merge conflicts between:

* **HEAD**: stateless filtering (`filterInput(input, { preserveIds })`) and the bridge/remap *messages* only.
* **a227eb4**: adds **prompt caching key**, **tools normalization**, and **conversation-memory**-aware `filterInput` (for call_id pairing).

Two conflict spots:

1. `filterInput(...)`
2. `transformRequestBody(...)` (extra params: `promptCacheKey` and `conversationMemory`)

### Minimal resolution that works **today** (no other file changes)

Keep **HEAD** function signatures (so nothing else breaks), but pull in the *safe* a227eb4 bits:

* keep:

  * `filterInput(input, { preserveIds })` (stateless)
  * `transformRequestBody(body, codexInstructions, userConfig, codexMode, { preserveIds })`

* add (inside `transformRequestBody`, no signature change):

  * **tools normalization** (Codex-style `tools`, `tool_choice: "auto"`, `parallel_tool_calls` heuristic)
  * leave `prompt_cache_key` out (your current SessionManager already handles IDs/continuity)

**Patch (drop the conflict markers and insert the marked section):**

```ts
// inside transformRequestBody(...) *after* body.instructions = codexInstructions;

// ---- BEGIN: add this safe block ----
// Tool behavior parity with Codex CLI (normalize shapes)
if (body.tools) {
  const normalizedTools = normalizeToolsForResponses(body.tools);
  if (normalizedTools && normalizedTools.length > 0) {
    (body as any).tools = normalizedTools;
    (body as any).tool_choice = "auto";
    const modelName = (body.model || "").toLowerCase();
    const codexParallelDisabled = modelName.includes("gpt-5-codex");
    (body as any).parallel_tool_calls = !codexParallelDisabled;
  }
}
// ---- END: add this safe block ----
```

…and keep the **HEAD** version of:

```ts
// HEAD version (keep this)
body.input = filterInput(body.input, { preserveIds });
```

This preserves current behavior:

* **Bridge** by default (`codexMode: true`)
* **Remap** when you set `CODEX_MODE=0`

---

## if you want the full **call_id memory** remapper (a227eb4 behavior)

That requires a little more than your single file:

1. **`request-transformer.ts`**

   * Keep `filterInput` stateless **and** add a **new** `filterInputStateful(input, memory)` (no signature break).
   * Export `ConversationMemory` + `storeConversationEntry(...)`.

2. **`fetch-helpers.ts`**

   * Create a **module-level** `conversationMemory` (Maps).
   * Pass it to `transformRequestBody(..., /* keep options */, /* promptCacheKey? */ undefined, conversationMemory)`.
   * Update `handleSuccessResponse(...)` to **tap the SSE** stream and call `storeConversationEntry(...)` when you see `type: "function_call"` in `response.output_item.added|created`.

This way you **don’t** touch `index.ts` at all, and you get call_id pairing for stateless turns.

If you want me to ship that fuller patch, say the word and I’ll commit those two files with the module-local memory + SSE tap so you get the proper `function_call` → `function_call_output` correlation without changing any public signatures.
