name: review-response

on:
  pull_request_review_comment:
    types: [created]

jobs:
  auto-review-response:
    if: github.event.comment.user.login == 'coderabbitai'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Verify OpenCode secret
        run: |
          if [ -z "$OPENCODE_API_KEY" ]; then
            echo "OPENCODE_API_KEY secret is required" >&2
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install OpenCode CLI
        run: |
          npm install -g opencode-ai@latest
          NPM_PREFIX="$(npm config get prefix)"
          echo "${NPM_PREFIX}/bin" >> "$GITHUB_PATH"
          opencode --version

      - name: Prepare review context
        id: context
        run: node scripts/review-response-context.mjs

      - name: Start fix branch
        id: branch
        run: |
          branch="${{ steps.context.outputs.branch_name }}-${{ github.run_id }}"
          git checkout -b "$branch"
          echo "name=$branch" >> "$GITHUB_OUTPUT"

      - name: Run review-response agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          opencode run \
            --agent review-response \
            --model opencode/big-pickle \
            --file review-context.md \
            "Follow the instructions inside review-context.md and resolve the review comment precisely."

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.diff.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Auto-resolve review comment #${{ steps.context.outputs.comment_id }}" || exit 0
          git push origin "${{ steps.branch.outputs.name }}"

      - name: Open pull request
        if: steps.diff.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          comment_url="${{ steps.context.outputs.comment_url }}"
          reviewer="${{ steps.context.outputs.reviewer }}"
          pr_number="${{ steps.context.outputs.pr_number }}"
          printf "%s\n%s\n%s\n" \
            "Automated follow-up for ${comment_url} by @${reviewer}." \
            "This branch contains a single commit generated by the review-response agent." \
            "Original PR: #${pr_number}." \
            > pr-body.txt
          gh pr create \
            --base "${{ steps.context.outputs.base_ref }}" \
            --head "${{ steps.branch.outputs.name }}" \
            --title "Resolve review comment #${{ steps.context.outputs.comment_id }}" \
            --body-file pr-body.txt

      - name: No-op notification
        if: steps.diff.outputs.has_changes != 'true'
        run: echo "Review-response agent produced no changes; skipping PR creation."
